# SPDX-FileCopyrightText: 2021 Mario Franke <research@m-franke.net>
#
# SPDX-License-Identifier: GPL-2.0-or-later

#
# Use the new message compiler introduced in OMNeT++ 5.3
#
MSGC:=$(MSGC) --msg6

# dump out the actual compiler and linker command line for easier debugging
ifneq ($(MAKECMDGOALS),clean)
$(info *** COMPILING with:)
$(info $(CXX) -c $(CXXFLAGS) $(COPTS))
$(info *** LINKING with:)
$(info $(SHLIB_LD) -o $O/$(TARGET) $(AS_NEEDED_OFF) $(WHOLE_ARCHIVE_ON) $(LIBS) $(WHOLE_ARCHIVE_OFF) $(OMNETPP_LIBS) $(LDFLAGS))
$(info Building...)
endif

# --- Link PROJ persistently (survives Makefile regeneration) ---
INCLUDE_PATH += $(shell pkg-config --cflags proj)
LIBS += $(shell pkg-config --libs proj)
# Add rpath so the runtime loader finds the same libproj we linked
LDFLAGS += $(shell pkg-config --libs-only-L proj | sed 's/-L/-Wl,-rpath,/g')

# makefrag

# Tell the linker to pull in all object files from Veins, Veins‑INET and Space‑Veins
# so that classes referenced only from NED files (e.g. AnnotationManager) are registered.
VEINS_LIBDIR      ?= $(VEINS_PROJ)/src
VEINS_INET_LIBDIR ?= $(VEINS_PROJ)/subprojects/veins_inet/src
SPACE_VEINS_LIBDIR?= $(SPACE_VEINS_PROJ)/src
INET_LIBDIR       ?= $(INET_PROJ)/src

USER_LIBS = \
    -L$(VEINS_LIBDIR)      -lveins      \
    -L$(VEINS_INET_LIBDIR) -lveins_inet \
    -L$(SPACE_VEINS_LIBDIR) -lspace_veins \
    -L$(INET_LIBDIR)       -lINET

# Append them with whole-archive to the list of libraries.  WHOLE_ARCHIVE_ON and
# WHOLE_ARCHIVE_OFF come from OMNeT++’s Makefile.inc.
LIBS += $(WHOLE_ARCHIVE_ON) $(USER_LIBS) $(WHOLE_ARCHIVE_OFF)

# Ensure the runtime loader can find the shared libs by adding rpath entries.
LDFLAGS += -Wl,-rpath,$(abspath $(VEINS_LIBDIR)) \
           -Wl,-rpath,$(abspath $(VEINS_INET_LIBDIR)) \
           -Wl,-rpath,$(abspath $(SPACE_VEINS_LIBDIR)) \
           -Wl,-rpath,$(abspath $(INET_LIBDIR))

